[{"type":"tab","id":"8df62a05.7209d8","label":"Visual looping"},{"type":"tab","id":"68e6389f.9719c8","label":"Valve"},{"type":"tab","id":"12be099a.ed41f6","label":"CSV"},{"type":"tab","id":"59acdeb6.a6532","label":"Web page"},{"id":"817e85f1.7e8178","type":"mqtt-broker","broker":"localhost","port":"1883"},{"id":"c9fdfb2c.360208","type":"twitter-credentials","screen_name":"@garethcoleman"},{"id":"ba926a1f.456d98","type":"twitter-credentials","screen_name":"@TodmordenAqua"},{"id":"ba386057.845d3","type":"mqtt-broker","broker":"localhost","port":"1883"},{"id":"b992ac0.f466d5","type":"debug","name":"","active":true,"complete":"false","x":801,"y":44,"z":"8df62a05.7209d8","wires":[]},{"id":"a91c9fd0.56e36","type":"function","name":"Block Air","func":"if (context.global.state == \"closing\" ) {\n    msg.payload = 'block air';\n\treturn msg;\n} else {\n\treturn null;\n}\n\n","outputs":"1","x":258,"y":58,"z":"8df62a05.7209d8","wires":[["b992ac0.f466d5","4e4e6c11.b1b194"]]},{"id":"27519337.d8ae6c","type":"function","name":"Fill a little","func":"if (context.global.state == 'closing' ) {\n\tmsg.payload = 'fill a little';\n\treturn msg;\n} else {\n\treturn null;\n}\n","outputs":1,"x":526,"y":122,"z":"8df62a05.7209d8","wires":[["b992ac0.f466d5","ef568e71.10a97"]]},{"id":"65ee41ab.9a11c","type":"delay","name":"... for 3s","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","x":550,"y":408,"z":"8df62a05.7209d8","wires":[["2dc032f.fd23fce"]]},{"id":"558b5007.aa74b","type":"function","name":"Fill up completely","func":"if (context.global.state != 'closing' && msg.payload == 'close') {\n\tmsg.payload = 'fill up completely';\n\tcontext.global.state = 'closing';\n} else {\n\tmsg = null;\n}\nreturn msg;","outputs":"1","x":337.1428527832031,"y":383.4285583496094,"z":"8df62a05.7209d8","wires":[["65ee41ab.9a11c","b3b21511.4c4de8"]]},{"id":"4e4e6c11.b1b194","type":"delay","name":"... for 4s","pauseType":"delay","timeout":"4","timeoutUnits":"seconds","rate":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","x":379,"y":93,"z":"8df62a05.7209d8","wires":[["27519337.d8ae6c"]]},{"id":"ef568e71.10a97","type":"delay","name":"... for 0.5s","pauseType":"delay","timeout":"0.5","timeoutUnits":"seconds","rate":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","x":607,"y":230,"z":"8df62a05.7209d8","wires":[["a91c9fd0.56e36"]]},{"id":"2cf94183.d306be","type":"mqtt in","name":"Valve Top-up Cycle","topic":"loop","broker":"817e85f1.7e8178","x":77,"y":34,"z":"8df62a05.7209d8","wires":[["a91c9fd0.56e36"]]},{"id":"2dc032f.fd23fce","type":"mqtt out","name":"Start Top-up Cycle","topic":"loop","broker":"817e85f1.7e8178","x":761,"y":408,"z":"8df62a05.7209d8","wires":[]},{"id":"3ad19af0.c52e66","type":"inject","name":"Fill Valve and Keep Full","topic":"valve","payload":"close","repeat":"","crontab":"","once":false,"x":137,"y":335,"z":"8df62a05.7209d8","wires":[["558b5007.aa74b"]]},{"id":"939ed25.f6c613","type":"inject","name":"Stop Topping Up","topic":"","payload":"0","repeat":"","crontab":"","once":false,"x":145,"y":554,"z":"8df62a05.7209d8","wires":[["c8659dcd.379a6"]]},{"id":"b3b21511.4c4de8","type":"debug","name":"","active":true,"complete":false,"x":531,"y":289,"z":"8df62a05.7209d8","wires":[]},{"id":"c8659dcd.379a6","type":"function","name":"Stop topping up","func":"context.global.state = null;","outputs":1,"x":407,"y":559,"z":"8df62a05.7209d8","wires":[[]]},{"id":"15aa03f7.ea55fc","type":"function","name":"Valve","func":"//outputs (exclusive)\nvar fill = null;\nvar hold = null;\nvar topup = null;\nvar empty = null;\n\n// initialise valve to idle if none exists\nvar initialValve = {state: 'idle'};\nvar valve = context.valve || initialValve;\n\n// interrupts\n// always empty when asked to\nif (msg.payload == 'empty') {\n    // unless already in process of emptying\n    if (valve.state == 'emptying') {\n          return null;\n        } else {\n            valve.state = \"readytoempty\";\n        }\n} else if (msg.payload == 'fill') {\n// but don't start a fill unless idle\n        if (valve.state != 'idle') {\n                return null;\n        } else {\n                valve.state = 'readytofill';\n        }\n}\n\nvar stately = context.global.stately;\nvar machine = stately.define({\n    readytofill: function (valve) {\n                fill = msg;\n                valve.state = 'filling';\n    },\n    filling: function (valve) {\n                hold = msg;\n                valve.state = 'holding';\n    },\n    holding: function (valve) {\n                topup = msg;\n                valve.state = 'filling';\n    },\n    readytoempty: function (valve) {\n        empty = msg;\n        valve.state = 'emptying';\n    },\n    emptying: function (valve) {\n        if (msg.payload == 'emptying') {\n                valve.state = 'idle';\n        }\n    }\n});\n\nmachine.handle(valve);\ncontext.valve = valve;\nreturn [fill, hold, topup, empty, {payload: 'state: '+valve.state}];","outputs":"5","x":205,"y":172.00000381469727,"z":"68e6389f.9719c8","wires":[["5c1831d2.a3e7d"],["65a99fa6.9a566"],["f26eeab7.0d9118"],["4e9595e.fb16a6c"],["1f362eb2.e0c9d1"]]},{"id":"6cff1c8e.9300e4","type":"inject","name":"Empty","topic":"","payload":"empty","repeat":"","crontab":"","once":false,"x":146,"y":87,"z":"68e6389f.9719c8","wires":[["313957ea.cec6a8"]]},{"id":"facdf0e6.05321","type":"inject","name":"Fill and Keep Full","topic":"","payload":"fill","repeat":"","crontab":"","once":false,"x":133,"y":32,"z":"68e6389f.9719c8","wires":[["313957ea.cec6a8"]]},{"id":"5c1831d2.a3e7d","type":"template","name":"filling","template":"filling","x":362,"y":95,"z":"68e6389f.9719c8","wires":[["de311faa.21cee","1f362eb2.e0c9d1"]]},{"id":"f26eeab7.0d9118","type":"template","name":"topping up","template":"topping up","x":366,"y":202,"z":"68e6389f.9719c8","wires":[["928dbb12.6d7248","1f362eb2.e0c9d1"]]},{"id":"4e9595e.fb16a6c","type":"template","name":"emptying","template":"emptying","x":368,"y":261,"z":"68e6389f.9719c8","wires":[["bf0a7660.40f588","1f362eb2.e0c9d1"]]},{"id":"65a99fa6.9a566","type":"template","name":"holding","template":"holding","x":359,"y":148,"z":"68e6389f.9719c8","wires":[["db88f19f.24771","1f362eb2.e0c9d1"]]},{"id":"ba5895b4.45a768","type":"mqtt in","name":"Valve Control","topic":"valvecontrol","broker":"817e85f1.7e8178","x":70,"y":173,"z":"68e6389f.9719c8","wires":[["15aa03f7.ea55fc"]]},{"id":"313957ea.cec6a8","type":"mqtt out","name":"Valve Control","topic":"valvecontrol","broker":"817e85f1.7e8178","x":308,"y":48,"z":"68e6389f.9719c8","wires":[]},{"id":"de311faa.21cee","type":"delay","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","x":501,"y":93,"z":"68e6389f.9719c8","wires":[["9d1e7e27.62e18"]]},{"id":"9d1e7e27.62e18","type":"mqtt out","name":"Valve Control","topic":"valvecontrol","broker":"817e85f1.7e8178","x":694,"y":171,"z":"68e6389f.9719c8","wires":[]},{"id":"db88f19f.24771","type":"delay","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","x":501,"y":147,"z":"68e6389f.9719c8","wires":[["9d1e7e27.62e18"]]},{"id":"928dbb12.6d7248","type":"delay","name":"","pauseType":"delay","timeout":"0.5","timeoutUnits":"seconds","rate":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","x":505,"y":199,"z":"68e6389f.9719c8","wires":[["9d1e7e27.62e18"]]},{"id":"bf0a7660.40f588","type":"delay","name":"","pauseType":"delay","timeout":"8","timeoutUnits":"seconds","rate":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","x":510,"y":261,"z":"68e6389f.9719c8","wires":[["9d1e7e27.62e18"]]},{"id":"1f362eb2.e0c9d1","type":"debug","name":"","active":true,"complete":false,"x":680,"y":425,"z":"68e6389f.9719c8","wires":[]},{"id":"19e4f7bc.e61b08","type":"file","name":"","filename":"/tmp/sensordata","appendNewline":true,"overwriteFile":false,"x":530,"y":103,"z":"12be099a.ed41f6","wires":[]},{"id":"5e2da9bb.a1d258","type":"inject","name":"Mock Temperature Sensor","topic":"","payload":"50","repeat":"5","crontab":"","once":false,"x":134,"y":44,"z":"12be099a.ed41f6","wires":[[]]},{"id":"83ef28a6.7c10d8","type":"template","name":"CSV Row Formatter","template":"{{date}}, {{payload}}","x":321,"y":100,"z":"12be099a.ed41f6","wires":[["19e4f7bc.e61b08"]]},{"id":"b54fd9ea.4ab028","type":"function","name":"Date Stamper","func":"msg.date = new Date().toISOString().slice(0, 19).replace('T', ' ');\nreturn msg;","outputs":1,"x":138,"y":103,"z":"12be099a.ed41f6","wires":[["83ef28a6.7c10d8"]]},{"id":"8e66139a.7199f","type":"http response","name":"http out","x":706,"y":244,"z":"59acdeb6.a6532","wires":[]},{"id":"8e6ca77a.719358","type":"http in","name":"","url":"/data","method":"get","x":158,"y":248,"z":"59acdeb6.a6532","wires":[["55d98f48.aa267"]]},{"id":"15b64867.ea49b8","type":"template","name":"Page Template","template":"\nHello there <br />\n\nAltitude: {{data.altitude}}<br />\nConcavity: {{data.concavity}}","x":520,"y":141,"z":"59acdeb6.a6532","wires":[["8e66139a.7199f"]]},{"id":"c9d524d3.362ad8","type":"inject","name":"","topic":"concavity","payload":"","repeat":"2","crontab":"","once":false,"x":171,"y":146,"z":"59acdeb6.a6532","wires":[["55d98f48.aa267"]]},{"id":"55d98f48.aa267","type":"function","name":"Data buffer","func":"context.data = context.data || new Object();\nswitch (msg.topic) {\n    case \"concavity\":\n        context.data.concavity = msg.payload;\n        msg = null;\n        break;\n    case \"altitude\":\n        context.data.altitude = msg.payload;\n        msg = null;\n        break;\n    default:\n    \tmsg.data = context.data;\n}\nreturn msg;","outputs":1,"x":354,"y":139,"z":"59acdeb6.a6532","wires":[["15b64867.ea49b8"]]},{"id":"78fa059c.8705fc","type":"inject","name":"","topic":"altitude","payload":"","repeat":"1","crontab":"","once":true,"x":178,"y":78,"z":"59acdeb6.a6532","wires":[["55d98f48.aa267"]]},{"id":"e7269dcf.18d96","type":"http in","name":"","url":"/web","method":"get","x":155,"y":312,"z":"59acdeb6.a6532","wires":[["4b985960.b467a8"]]},{"id":"4b985960.b467a8","type":"template","name":"Auto Update Script","template":"<script>\n    setInterval(function(){\t\n\t    var theUrl = \"http://aquadevpi:1880/data\";\n\t    var xmlHttp = new XMLHttpRequest();\n\t    xmlHttp.open( \"GET\", theUrl, false );\n\t    xmlHttp.send( null );\n\t    document. getElementById('data')\n\t    \t.innerHTML = xmlHttp.responseText;\n    },2000);\n</script>\n<div id = 'data'>\n ... Loading ...\n</div>\n","x":401,"y":302,"z":"59acdeb6.a6532","wires":[["8e66139a.7199f"]]}]