[{"type":"tab","id":"68e6389f.9719c8","label":"Valve"},{"type":"tab","id":"12be099a.ed41f6","label":"CSV"},{"type":"tab","id":"59acdeb6.a6532","label":"Web page"},{"type":"tab","id":"621ad2ed.9de52c","label":"test controls"},{"type":"tab","id":"c06fbd88.3f904","label":"Hardware"},{"id":"817e85f1.7e8178","type":"mqtt-broker","broker":"localhost","port":"1883"},{"id":"c9fdfb2c.360208","type":"twitter-credentials","screen_name":"@garethcoleman"},{"id":"ba926a1f.456d98","type":"twitter-credentials","screen_name":"@TodmordenAqua"},{"id":"ba386057.845d3","type":"mqtt-broker","broker":"localhost","port":"1883"},{"id":"15aa03f7.ea55fc","type":"function","name":"Valve","func":"//outputs (exclusive)\nvar fill = null;\nvar hold = null;\nvar topup = null;\nvar empty = null;\n\n// initialise valve to idle if none exists\nvar initialValve = {state: 'idle'};\nvar valve = context.valve || initialValve;\n\n// interrupts\n// always empty when asked to\nif (msg.payload == 'empty') {\n    // unless already in process of emptying\n    if (valve.state == 'emptying') {\n          return null;\n        } else {\n            valve.state = \"readytoempty\";\n        }\n} else if (msg.payload == 'fill') {\n// but don't start a fill unless idle\n        if (valve.state != 'idle') {\n                return null;\n        } else {\n                valve.state = 'readytofill';\n        }\n}\n\nvar stately = context.global.stately;\nvar machine = stately.define({\n    readytofill: function (valve) {\n                fill = msg;\n                valve.state = 'filling';\n    },\n    filling: function (valve) {\n                hold = msg;\n                valve.state = 'holding';\n    },\n    holding: function (valve) {\n                topup = msg;\n                valve.state = 'filling';\n    },\n    readytoempty: function (valve) {\n        empty = msg;\n        valve.state = 'emptying';\n    },\n    emptying: function (valve) {\n        if (msg.payload == 'idle') {\n                valve.state = 'idle';\n        } else {\n        \treturn null;\n        }\n    }\n});\n\nmachine.handle(valve);\ncontext.valve = valve;\nreturn [fill, hold, topup, empty, {payload: 'state: '+valve.state}];","outputs":"5","x":205,"y":172.00000381469727,"z":"68e6389f.9719c8","wires":[["5c1831d2.a3e7d"],["65a99fa6.9a566"],["f26eeab7.0d9118"],["4e9595e.fb16a6c"],[]]},{"id":"6cff1c8e.9300e4","type":"inject","name":"Empty","topic":"","payload":"empty","repeat":"","crontab":"","once":false,"x":146,"y":87,"z":"68e6389f.9719c8","wires":[["313957ea.cec6a8"]]},{"id":"facdf0e6.05321","type":"inject","name":"Fill and Keep Full","topic":"","payload":"fill","repeat":"","crontab":"","once":false,"x":133,"y":32,"z":"68e6389f.9719c8","wires":[["313957ea.cec6a8"]]},{"id":"5c1831d2.a3e7d","type":"template","name":"filling","template":"filling","x":362,"y":95,"z":"68e6389f.9719c8","wires":[["1f362eb2.e0c9d1","f8c88ef0.07377"]]},{"id":"f26eeab7.0d9118","type":"template","name":"topping up","template":"topping up","x":366,"y":202,"z":"68e6389f.9719c8","wires":[["1f362eb2.e0c9d1","26941978.d96be6"]]},{"id":"4e9595e.fb16a6c","type":"template","name":"emptying","template":"emptying","x":368,"y":261,"z":"68e6389f.9719c8","wires":[["1f362eb2.e0c9d1","a3465090.5cb9b"]]},{"id":"65a99fa6.9a566","type":"template","name":"holding","template":"holding","x":359,"y":148,"z":"68e6389f.9719c8","wires":[["1f362eb2.e0c9d1","2799673f.d86698"]]},{"id":"ba5895b4.45a768","type":"mqtt in","name":"Valve Control","topic":"valvecontrol","broker":"817e85f1.7e8178","x":70,"y":173,"z":"68e6389f.9719c8","wires":[["15aa03f7.ea55fc"]]},{"id":"313957ea.cec6a8","type":"mqtt out","name":"Valve Control","topic":"valvecontrol","broker":"817e85f1.7e8178","x":308,"y":48,"z":"68e6389f.9719c8","wires":[]},{"id":"de311faa.21cee","type":"delay","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","x":687.153881072998,"y":101.46153736114502,"z":"68e6389f.9719c8","wires":[["9d1e7e27.62e18"]]},{"id":"9d1e7e27.62e18","type":"mqtt out","name":"Valve Control","topic":"valvecontrol","broker":"817e85f1.7e8178","x":985.5385055541992,"y":163.30768966674805,"z":"68e6389f.9719c8","wires":[]},{"id":"db88f19f.24771","type":"delay","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","x":687.153881072998,"y":155.46153736114502,"z":"68e6389f.9719c8","wires":[["9d1e7e27.62e18"]]},{"id":"928dbb12.6d7248","type":"delay","name":"","pauseType":"delay","timeout":"0.5","timeoutUnits":"seconds","rate":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","x":691.153881072998,"y":207.46153736114502,"z":"68e6389f.9719c8","wires":[["9d1e7e27.62e18"]]},{"id":"bf0a7660.40f588","type":"delay","name":"","pauseType":"delay","timeout":"8","timeoutUnits":"seconds","rate":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","x":696.153881072998,"y":269.461537361145,"z":"68e6389f.9719c8","wires":[["f235b07.f0dca5","9d1e7e27.62e18","4fdf8625.b02078"]]},{"id":"1f362eb2.e0c9d1","type":"debug","name":"","active":true,"complete":false,"x":585.3846206665039,"y":560.3846244812012,"z":"68e6389f.9719c8","wires":[]},{"id":"19e4f7bc.e61b08","type":"file","name":"","filename":"/tmp/sensordata","appendNewline":true,"overwriteFile":false,"x":530,"y":103,"z":"12be099a.ed41f6","wires":[]},{"id":"5e2da9bb.a1d258","type":"inject","name":"Mock Temperature Sensor","topic":"","payload":"50","repeat":"5","crontab":"","once":false,"x":134,"y":44,"z":"12be099a.ed41f6","wires":[[]]},{"id":"83ef28a6.7c10d8","type":"template","name":"CSV Row Formatter","template":"{{date}}, {{payload}}","x":321,"y":100,"z":"12be099a.ed41f6","wires":[["19e4f7bc.e61b08"]]},{"id":"b54fd9ea.4ab028","type":"function","name":"Date Stamper","func":"msg.date = new Date().toISOString().slice(0, 19).replace('T', ' ');\nreturn msg;","outputs":1,"x":138,"y":103,"z":"12be099a.ed41f6","wires":[["83ef28a6.7c10d8"]]},{"id":"8e66139a.7199f","type":"http response","name":"http out","x":706,"y":244,"z":"59acdeb6.a6532","wires":[]},{"id":"8e6ca77a.719358","type":"http in","name":"","url":"/data","method":"get","x":158,"y":248,"z":"59acdeb6.a6532","wires":[["55d98f48.aa267"]]},{"id":"15b64867.ea49b8","type":"template","name":"Page Template","template":"\nHello there <br />\n\nAltitude: {{data.altitude}}<br />\nConcavity: {{data.concavity}}","x":520,"y":141,"z":"59acdeb6.a6532","wires":[["8e66139a.7199f"]]},{"id":"c9d524d3.362ad8","type":"inject","name":"","topic":"concavity","payload":"","repeat":"2","crontab":"","once":false,"x":171,"y":146,"z":"59acdeb6.a6532","wires":[["55d98f48.aa267"]]},{"id":"55d98f48.aa267","type":"function","name":"Data buffer","func":"context.data = context.data || new Object();\nswitch (msg.topic) {\n    case \"concavity\":\n        context.data.concavity = msg.payload;\n        msg = null;\n        break;\n    case \"altitude\":\n        context.data.altitude = msg.payload;\n        msg = null;\n        break;\n    default:\n    \tmsg.data = context.data;\n}\nreturn msg;","outputs":1,"x":354,"y":139,"z":"59acdeb6.a6532","wires":[["15b64867.ea49b8"]]},{"id":"78fa059c.8705fc","type":"inject","name":"","topic":"altitude","payload":"","repeat":"1","crontab":"","once":true,"x":178,"y":78,"z":"59acdeb6.a6532","wires":[["55d98f48.aa267"]]},{"id":"e7269dcf.18d96","type":"http in","name":"","url":"/web","method":"get","x":155,"y":312,"z":"59acdeb6.a6532","wires":[["4b985960.b467a8"]]},{"id":"4b985960.b467a8","type":"template","name":"Auto Update Script","template":"<script>\n    setInterval(function(){\t\n\t    var theUrl = \"http://aquadevpi:1880/data\";\n\t    var xmlHttp = new XMLHttpRequest();\n\t    xmlHttp.open( \"GET\", theUrl, false );\n\t    xmlHttp.send( null );\n\t    document. getElementById('data')\n\t    \t.innerHTML = xmlHttp.responseText;\n    },2000);\n</script>\n<div id = 'data'>\n ... Loading ...\n</div>\n","x":401,"y":302,"z":"59acdeb6.a6532","wires":[["8e66139a.7199f"]]},{"id":"63a177d1.9c5e88","type":"inject","name":"Test the Light Level","topic":"test_this","payload":"Far Light","repeat":"","crontab":"","once":false,"x":130.38460540771484,"y":134.46154022216797,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"e924ff66.16db","type":"function","name":"test gate","func":"context.testing = context.testing || 0;\nif (msg.topic == \"test_this\") {\n\tcontext.testing = msg.payload;\n}\nif (msg.topic == context.testing) {\n\treturn msg;\n}\n","outputs":1,"x":436.78936195373535,"y":406.5567398071289,"z":"621ad2ed.9de52c","wires":[["a9271d11.56d8e"]]},{"id":"1fa9246c.e056dc","type":"inject","name":"STOP TESTING","topic":"test_this","payload":"0","repeat":"","crontab":"","once":false,"x":120.5750961303711,"y":426.75914764404297,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"e9811c44.167ee","type":"inject","name":"Test the Air Pump 1 Current","topic":"test_this","payload":"Air Pump 1 Current","repeat":"","crontab":"","once":false,"x":154.41190719604492,"y":33.6107120513916,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"89b6ac70.76495","type":"mqtt out","name":"set LED level","topic":"led","broker":"817e85f1.7e8178","x":748.1226768493652,"y":388.22343015670776,"z":"621ad2ed.9de52c","wires":[]},{"id":"da4f49e1.25b0b8","type":"inject","name":"1 sec Trigger","topic":"","payload":"","repeat":"1","crontab":"","once":false,"x":115.23381805419922,"y":487.44567108154297,"z":"621ad2ed.9de52c","wires":[["f57f22a9.0a80e","785e3fd5.87a1c"]]},{"id":"f57f22a9.0a80e","type":"function","name":"LED sequence","func":"var levels = [0, 2, 5, 10, 25, 100];\ncontext.index = context.index || 0;\ncontext.index = context.index + 1;\n\nif (context.index == levels.length) {\n\tcontext.index = 0;\n}\n\nmsg.topic = 'led';\nmsg.payload = levels[context.index];\nreturn msg;","outputs":"1","x":286.4877700805664,"y":460.7789840698242,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"af530ce4.50acf","type":"inject","name":"Test the LED","topic":"test_this","payload":"led","repeat":"","crontab":"","once":false,"x":107.38459777832031,"y":345.46154022216797,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"a9271d11.56d8e","type":"function","name":"Test router","func":"var debugOut = null;\nvar ledOut = null;\nvar relayOut = null;\n\nswitch (msg.topic) {\n\tcase \"led\":\n\t\tledOut = msg;\n\t\tbreak;\n\tcase \"relay\":\n\t\trelayOut = msg;\n\t\tbreak;\n\tdefault:\n\t\tdebugOut = msg;\n}\nreturn [debugOut, ledOut, relayOut]","outputs":"3","x":562.1226768493652,"y":406.2234330177307,"z":"621ad2ed.9de52c","wires":[["ae7f0ca2.5180f"],["89b6ac70.76495"],["56a06e7.fa95f9"]]},{"id":"6a4d2758.95b2d8","type":"inject","name":"Test the Air Temperature","topic":"test_this","payload":"Air Temperature","repeat":"","crontab":"","once":false,"x":146.38460540771484,"y":166.46154022216797,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"5bcd5fcc.a432a","type":"inject","name":"Test the Water Temperature","topic":"test_this","payload":"Water Temperature","repeat":"","crontab":"","once":false,"x":156.88460540771484,"y":200.46154022216797,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"6f7a84f8.90857c","type":"inject","name":"Test the Water Pump Current","topic":"test_this","payload":"Water Pump Current","repeat":"","crontab":"","once":false,"x":159.29427528381348,"y":101.02248001098633,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"5e147fc2.a1eb8","type":"inject","name":"Test the Air Pump 2 Current","topic":"test_this","payload":"Air Pump 2 Current","repeat":"","crontab":"","once":false,"x":154.4119110107422,"y":67.19894790649414,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"4feed79.fb01128","type":"inject","name":"Test the Digital Water Level","topic":"test_this","payload":"Digital Water Level","repeat":"","crontab":"","once":false,"x":153.45602416992188,"y":233.14012908935547,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"56a06e7.fa95f9","type":"mqtt out","name":"set Relay state","topic":"relay","broker":"817e85f1.7e8178","x":744.7893905639648,"y":435.8067855834961,"z":"621ad2ed.9de52c","wires":[]},{"id":"8c95de66.736a2","type":"inject","name":"Test the Relay","topic":"test_this","payload":"relay","repeat":"","crontab":"","once":false,"x":109.45602416992188,"y":378.14012908935547,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"785e3fd5.87a1c","type":"function","name":"Relay sequence","func":"context.global.relaystate = \n\tcontext.global.relaystate ? 0 : 1;\n\t\t\nmsg.topic = 'relay';\nmsg.payload = context.global.relaystate;\nreturn msg;\n\n","outputs":"1","x":288.45603942871094,"y":497.1401596069336,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"f4364f82.0bc9b","type":"inject","name":"Test the Analogue Water Level","topic":"test_this","payload":"Analogue Water Level","repeat":"","crontab":"","once":false,"x":163.4560317993164,"y":268.14012908935547,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"ae7f0ca2.5180f","type":"debug","name":"Test Data","active":true,"complete":"false","x":724.5394020080566,"y":347.306791305542,"z":"621ad2ed.9de52c","wires":[]},{"id":"21664380.de99bc","type":"inject","name":"Test the pH","topic":"test_this","payload":"pH","repeat":"","crontab":"","once":false,"x":101.45602416992188,"y":297.14012908935547,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"16a322ef.e95cdd","type":"template","name":"Lux output","template":"{{topic}}: {{payload}} lux","x":616.4242858886719,"y":26.398051261901855,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"317b0e35.ce84f2","type":"template","name":"Amps Output","template":"{{topic}}: {{payload}} A","x":631.8211345672607,"y":156.73134803771973,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"faf0db8c.050f28","type":"mqtt in","name":"","topic":"Far Light","broker":"817e85f1.7e8178","x":491.3052215576172,"y":27.22343635559082,"z":"621ad2ed.9de52c","wires":[["16a322ef.e95cdd"]]},{"id":"9983b88a.667c48","type":"mqtt in","name":"","topic":"Air Pump 1 Current","broker":"817e85f1.7e8178","x":465.7496738433838,"y":125.50912570953369,"z":"621ad2ed.9de52c","wires":[["317b0e35.ce84f2"]]},{"id":"a500e024.5aff2","type":"mqtt in","name":"","topic":"Air Temperature","broker":"817e85f1.7e8178","x":473.52745056152344,"y":60.73141956329346,"z":"621ad2ed.9de52c","wires":[["c1ccea8.f3e3318"]]},{"id":"c1ccea8.f3e3318","type":"template","name":"Centigrade Output","template":"{{topic}}: {{payload}} C","x":638.1227035522461,"y":76.62030792236328,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"88a0c158.775f4","type":"mqtt in","name":"","topic":"Water Temperature","broker":"817e85f1.7e8178","x":463.52745246887207,"y":92.95361709594727,"z":"621ad2ed.9de52c","wires":[["c1ccea8.f3e3318"]]},{"id":"f58e7977.0a7188","type":"mqtt in","name":"","topic":"Water Pump Current","broker":"817e85f1.7e8178","x":463.52745246887207,"y":190.62023830413818,"z":"621ad2ed.9de52c","wires":[["317b0e35.ce84f2"]]},{"id":"af35a6ab.50ca58","type":"mqtt in","name":"","topic":"Air Pump 2 Current","broker":"817e85f1.7e8178","x":465.7496757507324,"y":158.50913333892822,"z":"621ad2ed.9de52c","wires":[["317b0e35.ce84f2"]]},{"id":"932e50a7.6cd1b","type":"mqtt in","name":"","topic":"Digital Water Level","broker":"817e85f1.7e8178","x":471.4639701843262,"y":258.66377353668213,"z":"621ad2ed.9de52c","wires":[["4f4e069e.b0b1f8"]]},{"id":"4f4e069e.b0b1f8","type":"template","name":"Unitless Output","template":"{{topic}}: {{payload}}","x":637.6782836914062,"y":240.378155708313,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"1aaee033.e5512","type":"template","name":"Centimeter Output","template":"{{topic}}: {{payload}} cm","x":646.7099838256836,"y":291.9177780151367,"z":"621ad2ed.9de52c","wires":[["e924ff66.16db"]]},{"id":"1ad1ccc0.e52e33","type":"mqtt in","name":"","topic":"Analogue Water Level","broker":"817e85f1.7e8178","x":464.32111167907715,"y":292.23525524139404,"z":"621ad2ed.9de52c","wires":[["1aaee033.e5512"]]},{"id":"27a17938.d85e86","type":"mqtt in","name":"","topic":"pH","broker":"817e85f1.7e8178","x":498.6068305969238,"y":223.6637659072876,"z":"621ad2ed.9de52c","wires":[["4f4e069e.b0b1f8"]]},{"id":"b27cab78.4d8358","type":"inject","name":"Block air","topic":"","payload":"block air","repeat":"","crontab":"","once":false,"x":125.45601654052734,"y":548.9734115600586,"z":"621ad2ed.9de52c","wires":[["48a99899.b75668"]]},{"id":"48a99899.b75668","type":"mqtt out","name":"","topic":"solenoids","broker":"817e85f1.7e8178","x":416.45601654052734,"y":575.9734115600586,"z":"621ad2ed.9de52c","wires":[]},{"id":"ca0b477b.35f4b8","type":"inject","name":"Allow air in","topic":"","payload":"allow air in","repeat":"","crontab":"","once":false,"x":119.45601654052734,"y":582.9734115600586,"z":"621ad2ed.9de52c","wires":[["48a99899.b75668"]]},{"id":"cbbd4f53.3442b","type":"inject","name":"Allow air out","topic":"","payload":"allow air out","repeat":"","crontab":"","once":false,"x":130.45601654052734,"y":616.9734115600586,"z":"621ad2ed.9de52c","wires":[["48a99899.b75668"]]},{"id":"f235b07.f0dca5","type":"template","name":"idle","template":"idle","x":882.8846549987793,"y":266.4422950744629,"z":"68e6389f.9719c8","wires":[["407699f3.bf8968"]]},{"id":"86ff8c12.79007","type":"mqtt out","name":"","topic":"solenoids","broker":"817e85f1.7e8178","x":912.4039459228516,"y":535.7692642211914,"z":"68e6389f.9719c8","wires":[]},{"id":"f8c88ef0.07377","type":"template","name":"allow air in","template":"allow air in","x":515.3845634460449,"y":98.46154022216797,"z":"68e6389f.9719c8","wires":[["de311faa.21cee","86ff8c12.79007"]]},{"id":"2799673f.d86698","type":"template","name":"block air","template":"block air","x":524.6153755187988,"y":150.00000762939453,"z":"68e6389f.9719c8","wires":[["db88f19f.24771","86ff8c12.79007"]]},{"id":"26941978.d96be6","type":"template","name":"allow air in","template":"allow air in","x":526.1539306640625,"y":207.6923065185547,"z":"68e6389f.9719c8","wires":[["928dbb12.6d7248","86ff8c12.79007"]]},{"id":"a3465090.5cb9b","type":"template","name":"allow air out","template":"allow air out","x":536.1538848876953,"y":263.0769386291504,"z":"68e6389f.9719c8","wires":[["bf0a7660.40f588","86ff8c12.79007"]]},{"id":"ebd4e54.f142b18","type":"function","name":"de-energise relay","func":"var wpi = context.global.wpi;\n\nwpi.digitalWrite(context.global.relaysetpin, 0);\nwpi.digitalWrite(context.global.relayresetpin, 0);\n\nmsg.payload = \"... and off.\"\nreturn msg;","outputs":"1","x":782.3077392578125,"y":235.38462829589844,"z":"c06fbd88.3f904","wires":[[]]},{"id":"bfa744.ff4058c","type":"delay","name":"10 ms delay","pauseType":"delay","timeout":"10","timeoutUnits":"milliseconds","rate":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","x":626.0856018066406,"y":235.94041442871094,"z":"c06fbd88.3f904","wires":[["ebd4e54.f142b18"]]},{"id":"6f5b0713.90a4f8","type":"function","name":"energise relay","func":"msg.payload = parseInt(msg.payload);\nvar wpi = context.global.wpi;\nif (msg.payload == 1) {\n\twpi.digitalWrite(context.global.relaysetpin, 1);\n} else {\n\twpi.digitalWrite(context.global.relayresetpin, 1);\n}\nreturn msg;","outputs":"1","x":479.1966857910156,"y":201.16244506835938,"z":"c06fbd88.3f904","wires":[["588e3526.a771cc","bfa744.ff4058c"]]},{"id":"588e3526.a771cc","type":"template","name":"Relay output","template":"{{#payload}}\n  Operating Relay\n{{/payload}}\n{{^payload}}\n  Reseting Relay\n{{/payload}}","x":627.8633422851562,"y":200.1624526977539,"z":"c06fbd88.3f904","wires":[["9441a694.6bbe58"]]},{"id":"40197093.bfe69","type":"mqtt in","name":"receive Relay instruction","topic":"relay","broker":"817e85f1.7e8178","x":280.86334228515625,"y":201.16246032714844,"z":"c06fbd88.3f904","wires":[["6f5b0713.90a4f8"]]},{"id":"9441a694.6bbe58","type":"debug","name":"","active":true,"complete":"false","x":770.0023803710938,"y":164.1626968383789,"z":"c06fbd88.3f904","wires":[]},{"id":"5a709a69.a58f64","type":"template","name":"LED output","template":"Setting light level to: {{payload}}%","x":626.8911743164062,"y":129.49594116210938,"z":"c06fbd88.3f904","wires":[["9441a694.6bbe58"]]},{"id":"9d2c2723.62d3d8","type":"template","name":"Solenoids output","template":"Solenoids set to {{payload}}","x":626.9745178222656,"y":165.16265869140625,"z":"c06fbd88.3f904","wires":[["9441a694.6bbe58"]]},{"id":"255a705b.daa59","type":"function","name":"set level","func":"// initialise the wpi to use the global context\nvar wpi = context.global.wpi;\n\nvar level = parseInt(msg.payload);\nwpi.pwmWrite(context.global.ledpin, level);\n\nreturn msg;","outputs":1,"x":480.78009033203125,"y":129.49584197998047,"z":"c06fbd88.3f904","wires":[["5a709a69.a58f64"]]},{"id":"253da39b.dac25c","type":"function","name":"set Solenoids","func":"var wpi = context.global.wpi;\nswitch (msg.payload) {\n\tcase \"block air\":\n\t\twpi.digitalWrite(context.global.valve1pin, 0);\n\t\twpi.digitalWrite(context.global.valve2pin, 0);\n\t\tbreak; \n\tcase \"allow air in\":\n\t\twpi.digitalWrite(context.global.valve1pin, 0);\n\t\twpi.digitalWrite(context.global.valve2pin, 1);\n\t\tbreak;\n\tcase \"allow air out\":\n\t\twpi.digitalWrite(context.global.valve1pin, 1);\n\t\twpi.digitalWrite(context.global.valve2pin, 0);\n\t\tbreak;\n\tdefault:\n\t\tmsg.payload = null;\n}\nreturn msg;","outputs":"1","x":447.30780029296875,"y":165.71812438964844,"z":"c06fbd88.3f904","wires":[["9d2c2723.62d3d8"]]},{"id":"ca2889f4.35d778","type":"mqtt in","name":"receive LED level","topic":"led","broker":"817e85f1.7e8178","x":314.55783462524414,"y":130.49589347839355,"z":"c06fbd88.3f904","wires":[["255a705b.daa59"]]},{"id":"6cc9f15e.93361","type":"mqtt in","name":"receive Solenoids instruction","topic":"solenoids","broker":"817e85f1.7e8178","x":234.9744873046875,"y":163.7181167602539,"z":"c06fbd88.3f904","wires":[["253da39b.dac25c"]]},{"id":"60c56d60.9f3a94","type":"mqtt in","name":"","topic":"system","broker":"817e85f1.7e8178","x":504.3077392578125,"y":328.38462829589844,"z":"c06fbd88.3f904","wires":[["d2c33839.2d3cc8"]]},{"id":"d2c33839.2d3cc8","type":"debug","name":"System Messages","active":false,"complete":"false","x":661.7268829345703,"y":291.4351348876953,"z":"c06fbd88.3f904","wires":[]},{"id":"75bd1d13.8a42e4","type":"function","name":"system setup","func":"\n// select pins used by add on board\ncontext.global.ledpin = 1;\ncontext.global.valve1pin = 3;\ncontext.global.valve2pin = 2;\ncontext.global.relaysetpin = 0;\ncontext.global.relayresetpin = 6;\ncontext.global.lcdbacklightpin = 7;\n\n// initialise the wpi to use the global context\nvar wpi = context.global.wpi;\n\n// use the default WiringPi pin number scheme...\nwpi.setup();\n\n// set the pin modes\nwpi.pinMode(context.global.lcdbacklightpin, wpi.modes.OUTPUT);\nwpi.pinMode(context.global.valve1pin, wpi.modes.OUTPUT);\nwpi.pinMode(context.global.valve2pin, wpi.modes.OUTPUT);\nwpi.pinMode(context.global.relaysetpin, wpi.modes.OUTPUT);\nwpi.pinMode(context.global.relayresetpin, wpi.modes.OUTPUT);\nwpi.pinMode(context.global.ledpin, wpi.modes.PWM_OUTPUT);\nwpi.pwmSetRange(100);\n\n// reset outputs\nwpi.pwmWrite(context.global.ledpin, 0);\nwpi.digitalWrite(context.global.valve1pin, 0);\nwpi.digitalWrite(context.global.valve2pin, 0);\n\n// exit loop\ncontext.global.loop = \"off\";\n\n// clear alert\ncontext.global.alertSent = false;\n\nreturn msg;","outputs":1,"x":483.5577850341797,"y":291.9755096435547,"z":"c06fbd88.3f904","wires":[["d2c33839.2d3cc8"]]},{"id":"3e1868d1.c1e798","type":"inject","name":"Reset system","topic":"","payload":"System reset!","repeat":"","crontab":"","once":true,"x":325.2395935058594,"y":291.4755096435547,"z":"c06fbd88.3f904","wires":[["75bd1d13.8a42e4"]]},{"id":"79ca9e20.86356","type":"function","name":"Log last arduino alive time","func":"if (msg.payload == 'alive') {\n\tcontext.global.lastAlive = new Date().getTime();\n}","outputs":1,"x":506.3077392578125,"y":414.38462829589844,"z":"c06fbd88.3f904","wires":[[]]},{"id":"7ff03226.800fcc","type":"mqtt in","name":"","topic":"system","broker":"817e85f1.7e8178","x":297.3077392578125,"y":414.38462829589844,"z":"c06fbd88.3f904","wires":[["79ca9e20.86356"]]},{"id":"b65e66ae.49a198","type":"inject","name":"Watchdog","topic":"","payload":"","repeat":"10","crontab":"","once":false,"x":306.3077392578125,"y":472.38462829589844,"z":"c06fbd88.3f904","wires":[["1cd9e1dc.e3261e"]]},{"id":"1cd9e1dc.e3261e","type":"function","name":"Check arduino alive","func":"if (context.global.alertSent == false\n\t&& context.global.lastAlive\n     \t< new Date().getTime() - 10000) {\n\tmsg.payload = 'The arduino is dead!';\n\tcontext.global.alertSent = true;\n} else {\n\tmsg = null;\n}\nreturn msg;","outputs":1,"x":475.3077392578125,"y":472.38462829589844,"z":"c06fbd88.3f904","wires":[["af79c142.50864","16fc3f60.e903c1"]]},{"id":"af79c142.50864","type":"twitter out","twitter":"ba926a1f.456d98","name":"Tweet","x":657.3077392578125,"y":471.38462829589844,"z":"c06fbd88.3f904","wires":[]},{"id":"16fc3f60.e903c1","type":"debug","name":"","active":true,"complete":false,"x":633.3077392578125,"y":524.3846282958984,"z":"c06fbd88.3f904","wires":[]},{"id":"407699f3.bf8968","type":"debug","name":"","active":true,"complete":false,"x":1021.2500152587891,"y":266.2500047683716,"z":"68e6389f.9719c8","wires":[]},{"id":"4fdf8625.b02078","type":"template","name":"block air","template":"block air","x":886.2500152587891,"y":316.2500047683716,"z":"68e6389f.9719c8","wires":[["86ff8c12.79007"]]}]